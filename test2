const axios = require('axios');

exports.streamChatFromChainlit = async (req, res) => {
  try {
    console.log('ğŸ” Incoming request to /api/fpa/chat');
    console.log('ğŸ“¥ Request body:', req.body);

    const fastApiUrl = 'http://localhost:8000/chat/stream'; // or wherever Chainlit is hosted

    // forward the cookie if available
    const accessToken = req.cookies?.access_token || req.headers['x-access-token'];

    if (!accessToken) {
      console.warn('âš ï¸ No access token found in cookies or headers');
    } else {
      console.log('ğŸ”‘ Access token found, forwarding to FastAPI');
    }

    console.log(`ğŸŒ Sending POST request to ${fastApiUrl}...`);

    const response = await axios.post(fastApiUrl, req.body, {
      headers: {
        Cookie: `access_token=${accessToken}`,
        'Content-Type': 'application/json',
      },
      responseType: 'stream', // Enable streaming response
    });

    console.log('âœ… Successfully connected to FastAPI. Streaming response to client...');

    // Handle stream piping
    response.data.pipe(res);

    response.data.on('end', () => {
      console.log('âœ… Stream ended');
    });

    response.data.on('error', (error) => {
      console.error('âŒ Stream error:', error);
    });

  } catch (err) {
    console.error('ğŸ”¥ Error proxying to FastAPI:', err.message);
    res.status(500).json({ error: 'Error proxying to FastAPI' });
  }
};
